<header class="site-header" role="banner" id="large-header">
  {%- assign default_paths = site.pages | map: "path" -%}
  {%- assign page_paths = site.header_pages | default: default_paths -%}
  <canvas id="canvas"></canvas>
  <div class='main-title'>
    <a class="site-title" rel="author"
      href="{{ "/" | relative_url }}">{{ site.title | escape }}</a>
    <sup>
      <a class="page-link" href="/about">Что это?</a>
    </sup>
    {%- include social.html -%}
  </div>
</header>
<script>

  const requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
    window.webkitRequestAnimationFrame || window.msRequestAnimationFrame

  const cancelAnimationFrame = window.cancelAnimationFrame || window.mozCancelAnimationFrame

  let points
  let particles
  let numOfParticles
  let animateHeader = true
  let largeHeader = document.getElementById('large-header')
  let canvas = document.getElementById('canvas')
  let ctx = canvas.getContext('2d')
  let width
  let height
  let raf
  // Main
  initHeader()
  addListeners()

  function Particle() {
    this.location = {
      x: Math.random() * width,
      y: Math.random() * height
    }
    this.speed = Math.random()
    this.angle = Math.random() * 360

    const r = Math.round(Math.random() * 255)
    const g = Math.round(Math.random() * 255)
    const b = Math.round(Math.random() * 255)
    const a = Math.random() * 0.1
    this.rgba = "rgba(" + r + ", " + g + "," + b + ", " + a + ")"
  }

  function initHeader() {
    cancelAnimationFrame(raf)
    width = window.innerWidth
    height = window.innerHeight - 100
    largeHeader.style.height = height + 'px'
    largeHeader.style.width = width + 'px'

    canvas.width = width
    canvas.height = height

    particles = []

    numOfParticles = width / 10

    for (var i = 0; i < numOfParticles; i++) {
      particles.push(new Particle())
    }

    function draw() {
      if (animateHeader) {
        ctx.globalCompositeOperation = "source-over"
        ctx.fillStyle = "rgba(1, 1, 1, 0.2)"
        ctx.fillRect(0, 0, width, height)

        ctx.globalCompositeOperation = "lighter"
        for (let i = 0; i < particles.length; i++) {
          const p = particles[i]
          ctx.beginPath()

          for (let n = 0; n < particles.length; n++) {
            const p2 = particles[n]
            const yd = p2.location.y - p.location.y
            const xd = p2.location.x - p.location.x
            const distance = Math.sqrt(xd * xd + yd * yd)

            if (distance < 140) {
              ctx.lineWidth = 1
              ctx.moveTo(p.location.x, p.location.y)
              ctx.lineTo(p2.location.x, p2.location.y)
            }
          }
          ctx.strokeStyle = p.rgba
          ctx.stroke()

          p.location.x = p.location.x + p.speed * Math.cos(p.angle * Math.PI / 180)
          p.location.y = p.location.y + p.speed * Math.sin(p.angle * Math.PI / 180)

          if (p.location.x < 0) p.location.x = width + 50
          if (p.location.x > width + 50) p.location.x = 0
          if (p.location.y < 0) p.location.y = height + 50
          if (p.location.y > height + 50) p.location.y = 0

        }
      }
      raf = requestAnimationFrame(draw)

    }

    //setInterval(draw, 3)
    raf = requestAnimationFrame(draw)
  }

  // Event handling
  function addListeners() {
    window.addEventListener('scroll', scrollCheck)
    window.addEventListener('resize', initHeader)
  }
  function scrollCheck() {
    animateHeader = document.documentElement.scrollTop < height / 2
  }

</script>